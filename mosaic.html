<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Processing Sketch in HTML</title>
  <!-- Processing.js ライブラリの読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/processing.js/1.6.6/processing.min.js"></script>
</head>
<body>
  <!-- ファイルアップロードフォーム -->
  <input type="file" id="uploadInput" accept="image/png">
  <br>
  <!-- Processingスケッチを描画するためのcanvas要素 -->
  <canvas id="mycanvas"></canvas>

  <script type="text/javascript">
    // ファイルアップロード時の処理
    document.getElementById('uploadInput').addEventListener('change', function(event) {
      var file = event.target.files[0];
      var reader = new FileReader();
      reader.onload = function(event) {
        img = new Image();
        img.src = event.target.result;
        img.onload = function() {
          // Processingスケッチを再描画
          myp5.setup();
        };
      };
      reader.readAsDataURL(file);
    });

    // Processingスケッチを初期化するJavaScriptコード
    var sketch = function(p) {
      var bubbles; // Bubbleクラスを格納するArrayList
      var img;
      var maxSize = 60;

      p.setup = function() {
        p.createCanvas(800, 600);
        p.frameRate(60);
        p.noStroke();
        //ArrayListの初期化
        bubbles = new Array();
        if (img) {
          img.resize(p.width, p.height);
        }
        //最初のきっかけの円を描画する
        for (var i = 0; i < 10; i++) {
          var loc = p.createVector(p.random(p.width), p.random(p.height));
          bubbles.push(new Bubble(loc));
        }
      };

      p.draw = function() {
        p.background(0);
        //ArrayListに格納された数だけBubbleを描画
        for (var i = 0; i < bubbles.length; i++) {
          bubbles[i].draw();
        }
        //Bubbleの状態を確認
        for (var i = 0; i < bubbles.length; i++) {
          //もしアクティブな結果だったら
          if (bubbles[i].isDead == false) {
            //円の周囲のピクセルの色を確認
            var expand = bubbles[i].checkPixel();
            //もしこれ以上膨張できない場合
            if (expand == false) {
              //新規にBubbleを生成
              var loc;
              //余白が見つかるまで繰り返し
              while (true) {
                loc = p.createVector(p.random(p.width), p.random(p.height));
                var c = p.get(int(loc.x), int(loc.y));
                if ((p.red(c) + p.blue(c) + p.green(c)) == 0) break;
              }
              //余白に新規Bubbleを生成
              bubbles.push(new Bubble(loc));
              bubbles[i].isDead = true;
            }
          }
        }
      };

      //マウスクリックで初期化
      p.mouseClicked = function() {
        // ArrayListをクリア
        bubbles = [];
        //きっかけの円を描画
        for (var i = 0; i < 100; i++) {
          var loc = p.createVector(p.random(p.width), p.random(p.height));
          bubbles.push(new Bubble(loc));
        }
      };

      // Bubbleクラス
      // 円が膨張しながら空間を重鎮していく
      var Bubble = function(_location) {
        this.size = 0;
        this.expandSpeed = 4.0;
        if (img) {
          this.circleColor = p.color(img.get(int(_location.x), int(_location.y)));
        } else {
          this.circleColor = p.color(255); // デフォルトの色
        }
        this.location = _location;
        this.expand = true;
        this.isDead = false;
      };

      Bubble.prototype.draw = function() {
        if (this.expand == true) {
          this.size += this.expandSpeed;
        }
        p.fill(this.circleColor);
        p.ellipse(this.location.x, this.location.y, this.size, this.size);
      };

      Bubble.prototype.checkPixel = function() {
        var nextSize = this.size + this.expandSpeed;
        for (var i = 0; i < p.TWO_PI; i += 0.01) {
          var x = p.int(p.cos(i) * nextSize / 2.0 + this.location.x);
          var y = p.int(p.sin(i) * nextSize / 2.0 + this.location.y);
          var c = p.get(x, y);
          if ((p.red(c) + p.blue(c) + p.green(c)) > 0 || this.size > maxSize) {
            this.expand = false;
          }
        }
        return this.expand;
      };
    };

    // Processingスケッチをmycanvasに適用
    var myp5 = new p5(sketch, 'mycanvas');
  </script>
</body>
</html>
